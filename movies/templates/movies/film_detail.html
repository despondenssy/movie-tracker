{% extends "base.html" %}
{% load static %}

{% block title %}{{ film.title }} ‚Äî Cinema Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/film_detail.css' %}">
{% endblock %}

{% block content %}
<div class="film-hero mb-4">
    <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
        <div>
            <h1 class="film-title">{{ film.title }}</h1>
            <div class="film-subtitle mt-2">
                <strong>{{ film.get_type_display }}</strong>
                {% if film.start_year %}
                    ‚Ä¢
                    {% if film.end_year %}
                        {{ film.start_year }}‚Äì{{ film.end_year }}
                    {% else %}
                        {{ film.start_year }}
                    {% endif %}
                {% endif %}
                {% if user_watch_status %}
                    ‚Ä¢ Your status: <strong>{{ user_watch_status|title }}</strong>
                {% endif %}
            </div>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'search_movies' %}{% if query %}?q={{ query|urlencode }}{% endif %}">‚Üê Back to search</a>
        </div>
    </div>

    {% if film.genres.all %}
        <div class="film-meta-badges mt-3">
            {% for genre in film.genres.all %}
                <span class="badge text-bg-secondary me-1 mb-1">{{ genre.name }}</span>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row g-3 mt-2">
        <div class="col-12 col-lg-8">
            <div class="d-flex flex-column flex-md-row gap-3 align-items-start">
                {% if tmdb_poster_url %}
                    <div class="film-poster-wrapper">
                        <img src="{{ tmdb_poster_url }}" alt="{{ film.title }}" class="film-poster">
                    </div>
                {% endif %}
                <div class="flex-grow-1">
                    {% if film.description %}
                        <p class="mb-0">{{ film.description }}</p>
                    {% else %}
                        <p class="mb-0 text-muted">No description yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="d-flex gap-2">
                <div class="stat-pill flex-fill">
                    <div class="label">CinemaTracker rating</div>
                    <div class="value">
                        {% if avg_rating %}
                            {{ avg_rating|floatformat:1 }} / 10
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                    <div class="small text-muted mt-1">
                        {% if rating_count %}Based on {{ rating_count }} review{{ rating_count|pluralize }}{% else %}No reviews yet{% endif %}
                    </div>
                </div>
                <div class="stat-pill flex-fill">
                    <div class="label">TMDB rating</div>
                    <div class="value">
                        {% if tmdb_rating %}
                            {{ tmdb_rating|floatformat:1 }} / 10
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                    <div class="small text-muted mt-1">
                        {% if tmdb_vote_count %}
                            {{ tmdb_vote_count }} vote{{ tmdb_vote_count|pluralize }} on TMDB
                        {% else %}
                            No TMDB rating
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Left column: community reviews + recommendations -->
    <div class="col-12 col-lg-8">
        <div class="review-card p-3 p-md-4 mb-4">
            <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                <h2 class="h4 mb-0">Reviews</h2>
                {% if user.is_authenticated and user_review %}
                    <div class="text-muted small">
                        Your rating: <strong>{{ user_review.rating }}/10</strong>
                    </div>
                {% endif %}
            </div>

            <div class="mt-3">
                {% if reviews %}
                    {% for r in reviews %}
                        <div class="border rounded-3 p-3 mb-3 bg-white">
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <div>
                                    <strong>{{ r.user.username }}</strong>
                                    <span class="text-muted small">‚Ä¢ {{ r.updated_at|date:"M d, Y" }}</span>
                                </div>
                                <div class="badge text-bg-primary" style="border-radius: 999px;">
                                    {{ r.rating }}/10
                                </div>
                            </div>
                            {% if r.text %}
                                <div class="mt-2">{{ r.text }}</div>
                            {% else %}
                                <div class="mt-2 text-muted">No text review.</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-muted">No reviews yet. Be the first to rate it.</div>
                {% endif %}
            </div>
        </div>

        <div class="review-card p-3 p-md-4">
            <h2 class="h4 mb-3">Recommendations</h2>

            {% if recommendations %}
                <div class="row g-3">
                    {% for rec in recommendations %}
                        <div class="col-12 col-sm-6 col-lg-4">
                            <a class="d-block rec-card p-3 h-100" href="{% url 'film_detail' rec.id %}{% if query %}?q={{ query|urlencode }}{% endif %}">
                                <div class="fw-semibold">{{ rec.title }}</div>
                                <div class="text-muted small mt-1">
                                    {{ rec.get_type_display }}
                                    {% if rec.start_year %}‚Ä¢ {{ rec.start_year }}{% endif %}
                                    {% if rec.avg_rating %}‚Ä¢ ‚òÖ {{ rec.avg_rating|floatformat:1 }}{% endif %}
                                </div>
                                {% if rec.genres.all %}
                                    <div class="mt-2">
                                        {% for g in rec.genres.all|slice:":3" %}
                                            <span class="badge text-bg-secondary me-1 mb-1">{{ g.name }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-muted">No recommendations yet ‚Äî add more films to your library to improve it.</div>
            {% endif %}
        </div>
    </div>

    <!-- Right column: actions -->
    <div class="col-12 col-lg-4">
        <div class="action-card p-3 p-md-4 mb-4">
            <h2 class="h5 mb-3">Your watch status</h2>

            {% if user.is_authenticated %}
                <form method="post" action="{% url 'set_film_status' film.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="query" value="{{ query }}">
                    <div class="d-grid gap-2">
                        <button class="btn-status {% if user_watch_status == 'planned' %}active{% endif %}" type="submit" name="status" value="planned">üìã Planned</button>
                        <button class="btn-status {% if user_watch_status == 'watching' %}active{% endif %}" type="submit" name="status" value="watching">‚ñ∂Ô∏è Watching</button>
                        <button class="btn-status {% if user_watch_status == 'watched' %}active{% endif %}" type="submit" name="status" value="watched">‚úÖ Watched</button>
                        <button class="btn-status {% if user_watch_status == 'dropped' %}active{% endif %}" type="submit" name="status" value="dropped">‚ùå Dropped</button>
                    </div>
                </form>
            {% else %}
                <div class="text-muted mb-3">Log in to track status and write reviews.</div>
                <a class="btn w-100" href="{% url 'login' %}">Login</a>
            {% endif %}
        </div>

        <div class="action-card p-3 p-md-4">
            <h2 class="h5 mb-3">Your rating & review</h2>

            {% if user.is_authenticated %}
                <form method="post" action="{% url 'upsert_review' film.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="query" value="{{ query }}">

                    <label class="form-label fw-semibold" for="rating">Rating</label>
                    <select class="form-select mb-3" id="rating" name="rating" required>
                        <option value="" disabled {% if not user_review %}selected{% endif %}>Choose 1‚Äì10</option>
                        <option value="1" {% if user_review and user_review.rating == 1 %}selected{% endif %}>1</option>
                        <option value="2" {% if user_review and user_review.rating == 2 %}selected{% endif %}>2</option>
                        <option value="3" {% if user_review and user_review.rating == 3 %}selected{% endif %}>3</option>
                        <option value="4" {% if user_review and user_review.rating == 4 %}selected{% endif %}>4</option>
                        <option value="5" {% if user_review and user_review.rating == 5 %}selected{% endif %}>5</option>
                        <option value="6" {% if user_review and user_review.rating == 6 %}selected{% endif %}>6</option>
                        <option value="7" {% if user_review and user_review.rating == 7 %}selected{% endif %}>7</option>
                        <option value="8" {% if user_review and user_review.rating == 8 %}selected{% endif %}>8</option>
                        <option value="9" {% if user_review and user_review.rating == 9 %}selected{% endif %}>9</option>
                        <option value="10" {% if user_review and user_review.rating == 10 %}selected{% endif %}>10</option>
                    </select>

                    <label class="form-label fw-semibold" for="text">Review (optional)</label>
                    <textarea class="form-control mb-3" id="text" name="text" rows="4" placeholder="What did you like/dislike?">{% if user_review %}{{ user_review.text }}{% endif %}</textarea>

                    <button class="btn w-100" type="submit">Save</button>
                    <div class="text-muted small mt-2">
                        You can update your rating and review anytime.
                    </div>
                </form>
            {% else %}
                <div class="text-muted">Log in to rate and review.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

